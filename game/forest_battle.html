<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forest</title>
  <link rel="stylesheet" href="./styles/battle.css" />
  <style>
    :root {
      --scene-w: 720px;
      --scene-h: 504px;
      --side-w: 320px;
      --gap: 16px;
      --monster-scale: 7;
      --monster-nudge: 300px;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: url("../assets/overworld.png") center/cover no-repeat fixed;
      color: #e7edf5;
      text-align: center;
    }

    h1 { margin: 12px 0; }

    #battle-layout {
      width: min(100%, calc(var(--scene-w) + var(--side-w) + var(--gap) + 24px));
      margin: 0 auto 24px;
      padding: 0 12px;
      display: grid;
      grid-template-columns: var(--scene-w) var(--side-w);
      gap: var(--gap);
      align-items: start;
    }

    @media (max-width:1100px) { #battle-layout { grid-template-columns: 1fr; } }

    .scene {
      position: relative;
      width: var(--scene-w);
      height: var(--scene-h);
      margin: 8px auto;
      overflow: hidden;
    }

    #region-bg {
      position: absolute;
      inset: 0;
      z-index: 1;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      image-rendering: pixelated;
      width: 100%;
      height: 100%;
    }

    .frame-border {
      position: absolute;
      inset: 0;
      z-index: 2;
      pointer-events: none;
      border: 10px solid #aeb3c3;
      border-radius: 12px;
      box-shadow: inset 0 0 0 2px #6b7485, 0 0 0 2px rgba(0, 0, 0, .35);
    }

    #enemy-image {
      position: absolute;
      left: 50%;
      bottom: 8px;
      transform: translate(calc(-50%), var(--monster-nudge)) scale(var(--monster-scale));
      transform-origin: bottom center;
      image-rendering: pixelated;
      z-index: 3;
      max-width: none;
      max-height: none;
    }

    #console {
      background: rgba(0, 0, 0, .35);
      padding: 10px 12px;
      border-radius: 8px;
      text-align: left;
      width: var(--scene-w);
      margin: 0 auto;
      min-height: 54px;
      box-sizing: border-box;
    }

    #sidebar { display: grid; gap: var(--gap); }

    #enemy-info, #character-info {
      background: rgba(0, 0, 0, .75);
      padding: 12px;
      border-radius: 8px;
      text-align: left;
    }

    #ability-buttons, #control-buttons {
      display: grid;
      gap: 10px;
    }

    .attack-btn, .action-btn {
      padding: 10px 12px;
      border: 2px solid #3a4a5f;
      background: #16212e;
      color: #e7edf5;
      border-radius: 10px;
      cursor: pointer;
    }

    .disabled { opacity: 0.5; pointer-events: none; }
  </style>
</head>

<body>
  <h1>Forest</h1>

  <div id="battle-layout">
    <div id="left">
      <div class="scene">
        <div id="region-bg"></div>
        <img id="enemy-image" alt="Enemy" />
        <img id="frame" src="../assets/sprites/battle_background.png" alt="Frame" />
        <div class="frame-border"></div>
      </div>
      <div id="console"><p id="battleText">A Forest enemy approaches!</p></div>
    </div>

    <div id="sidebar">
      <div id="enemy-info">
        <h3 id="enemy-name"></h3>
        <p>HP: <span id="enemy-hp"></span></p>
      </div>

      <div id="character-info">
        <h3 id="player-name"></h3>
        <p>HP: <span id="player-hp"></span></p>
        <p>Gold: <span id="player-gold"></span></p>
      </div>

      <div id="ability-buttons">
        <button class="attack-btn" onclick="playerAttack(0)">Attack 1</button>
        <button class="attack-btn" onclick="playerAttack(1)">Attack 2</button>
      </div>

      <div id="control-buttons">
        <button id="run-btn" class="action-btn">Run</button>
      </div>
    </div>
  </div>

  <script src="./js/characters.js"></script>
  <script src="./js/enemies.js"></script>
  <script src="./js/regions.js"></script>

  <script>
    const qs = new URLSearchParams(location.search);
    const regionKey = "forest";
    const charData = qs.get("character");
    let character = charData ? JSON.parse(decodeURIComponent(charData)) : null;

    let playerHP   = character?.currentHp ?? 100;
    let playerGold = character?.gold ?? 0;
    let playerName = character?.name ?? "Hero";
    let playerAbilities = character?.abilities ?? [
      { name: "Strike", damage: 10 },
      { name: "Guard", heal: 5 }
    ];

    // Fill player UI
    document.getElementById("player-name").textContent = playerName;
    document.getElementById("player-hp").textContent   = playerHP;
    document.getElementById("player-gold").textContent = playerGold;

    // Ability buttons
    document.querySelectorAll(".attack-btn").forEach((btn, i) => {
      const a = playerAbilities[i];
      if (a) btn.textContent = a.name; else btn.style.display = "none";
    });

    // Region background
    const regionCfg = regions[regionKey];
    const regionBg  = regionCfg?.battleBg ?? "../assets/sprites/game_background.png";
    document.getElementById("region-bg").style.backgroundImage = `url("${regionBg}")`;

    // Enemy pool
    const catalog = enemies.enemies || [];
    const pool = regionCfg?.monstersByName?.length
      ? catalog.filter(e => regionCfg.monstersByName.includes(e.name))
      : catalog.slice();

    if (!pool.length) {
      document.getElementById("enemy-name").textContent = "No enemies";
      document.getElementById("battleText").textContent = "This area is safe.";
      document.querySelectorAll(".attack-btn").forEach(b => b.disabled = true);
    } else {
      // Enemy setup
      const enemy = pool[Math.floor(Math.random() * pool.length)];
      let enemyHP = enemy.hp;
      let monsterDefeated = false;

      document.getElementById("enemy-name").textContent = enemy.name;
      document.getElementById("enemy-hp").textContent   = enemyHP;
      document.getElementById("enemy-image").src        = enemy.animations.idle;

      function updateEnemyDisplay() {
        document.getElementById("enemy-hp").textContent = enemyHP;
        document.getElementById("enemy-image").src = monsterDefeated ? enemy.animations.death : enemy.animations.idle;
      }
      function updatePlayerDisplay() {
        document.getElementById("player-hp").textContent   = playerHP;
        document.getElementById("player-gold").textContent = playerGold;
        if (character) { character.currentHp = playerHP; character.gold = playerGold; }
      }

      window.playerAttack = function(index) {
        if (monsterDefeated || playerHP <= 0) return;
        const ability = playerAbilities[index];
        if (!ability) return;

        let battleText = `You used ${ability.name}! `;

        if (ability.damage) {
          enemyHP -= ability.damage;
          battleText += `${enemy.name} took ${ability.damage} damage. `;
        }
        if (ability.heal) {
          const healed = Math.min(ability.heal, 100 - playerHP);
          playerHP += healed;
          battleText += `You healed for ${healed} HP. `;
        }

        if (enemyHP <= 0) {
          enemyHP = 0;
          monsterDefeated = true;
          playerGold += enemy.gold ?? 0;
          battleText = `You defeated ${enemy.name}! You gained ${enemy.gold ?? 0} gold.`;
        } else {
          // Enemy strikes back
          const dmg = enemy.attack ?? 5;
          playerHP -= dmg;
          if (playerHP < 0) playerHP = 0;
          battleText += `${enemy.name} strikes back for ${dmg} damage!`;

          if (playerHP <= 0) {
            battleText = `You were defeated by ${enemy.name}...`;
            document.querySelectorAll(".attack-btn").forEach(b => b.disabled = true);
          }
        }

        document.getElementById("battleText").innerText = battleText;
        updateEnemyDisplay();
        updatePlayerDisplay();
      };
    }

    // Run button â†’ back to overworld
    document.getElementById("run-btn").addEventListener("click", () => {
      const params = new URLSearchParams();
      if (character) params.set("character", encodeURIComponent(JSON.stringify(character)));
      params.set("region_type", regionKey);
      location.href = `overworld.html?${params.toString()}`;
    });

    // ESC shortcut
    window.addEventListener("keydown", (e) => { if (e.key === "Escape") document.getElementById("run-btn").click(); });
  </script>
</body>
</html>
