<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <link rel="stylesheet" href="battle.css">
    <style>
        :root {
            --scene-w: 720px;
            --scene-h: 504px;
            --side-w: 320px;
            --gap: 16px;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background: url("../assets/overworld.png") center/cover no-repeat fixed;
            color: #e7edf5;
            text-align: center;
        }

        #shop-layout {
            width: min(100%, calc(var(--scene-w) + var(--side-w) + var(--gap) + 24px));
            margin: 0 auto 24px;
            padding: 0 12px;
            display: grid;
            grid-template-columns: var(--scene-w) var(--side-w);
            gap: var(--gap);
            align-items: start;
        }

        .scene {
            position: relative;
            width: var(--scene-w);
            height: var(--scene-h);
            margin: 8px auto;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, .25);
            border-radius: 12px;
        }

        #character-image {
            max-width: 50%;
            image-rendering: pixelated;
        }

        #console {
            background: rgba(0, 0, 0, .35);
            padding: 10px 12px;
            border-radius: 8px;
            text-align: left;
            width: var(--scene-w);
            margin: 0 auto;
            min-height: 54px;
            box-sizing: border-box;
        }

        #sidebar {
            display: grid;
            gap: var(--gap);
        }

        #character-info {
            background: rgba(0, 0, 0, .75);
            padding: 12px;
            border-radius: 8px;
            text-align: left;
        }

        #shop-items {
            display: grid;
            gap: 10px;
        }

        .shop-btn {
            padding: 10px 12px;
            border: 2px solid #3a4a5f;
            background: #16212e;
            color: #e7edf5;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <h1>Shop</h1>

    <div id="shop-layout">
        <div id="left">
            <div class="scene">
                <img id="character-image" alt="Character">
            </div>
            <div id="console">
                <p id="shop-text">Welcome to the shop!</p>
            </div>
        </div>

        <!-- Shop Items Grid -->
        <div id="shop-container" class="shop-grid">
            <div class="shop-card">
                <img src="../assets/sprites/card_background.png" class="card-bg" alt="Card Background">
                <div class="item-info">
                    <h3>Health Potion</h3>
                    <p class="item-description">Restores 50 HP instantly</p>
                    <p class="item-price">Cost: 25 Gold</p>
                    <img src="../assets/sprites/select_button.png" class="buy-btn" data-item="health_restore"
                        data-cost="25" alt="Buy Button">
                </div>
            </div>

            <div id="shop-items">
                <h4>Buy Permanent Buffs</h4>
                <button class="shop-btn" id="buy-hp">+20 Max HP (50 Gold)</button>
                <button class="shop-btn" id="upgrade-ability">Upgrade Ability Damage (+5) (100 Gold)</button>
                <button class="shop-btn" id="exit-shop">Exit Shop</button>
            </div>
        </div>
    </div>

    <script src="../assets/js/characters.js"></script>
    <script>
        const buttonSound = new Audio("../assets/sound/button_sound.mp3");

        // Initialize shop with player data from URL
        function initializeShop() {
            const params = new URLSearchParams(window.location.search);
            const charData = params.get("character");

            if (charData) {
                const character = JSON.parse(decodeURIComponent(charData));
                updatePlayerStats(character);

                // Store character data globally for purchases
                window.currentCharacter = character;
            } else {
                // Fallback if no character data
                document.getElementById('gold-amount').textContent = 100;
                document.getElementById('char-name').textContent = 'No Character';
                document.getElementById('current-hp').textContent = 0;
                document.getElementById('max-hp').textContent = 0;
                document.getElementById('attack-power').textContent = 0;
                window.currentCharacter = null;
            }
        }

        // Function to update player stats display
        function updatePlayerStats(character) {
            if (!character) return;

            document.getElementById('gold-amount').textContent = character.gold || 0;
            document.getElementById('char-name').textContent = character.name || 'Unknown';
            document.getElementById('current-hp').textContent = character.currentHp || 0;
            document.getElementById('max-hp').textContent = character.maxHp || 0;

            // Show only extra attack damage from purchases (0 if none)
            const extraAttack = character.attackBonus || 0;
            document.getElementById('attack-power').textContent = extraAttack;
        }

        // Handle item purchases
        function buyItem(itemType, cost) {
            if (!window.currentCharacter) {
                alert('No character data found!');
                return;
            }

            const character = window.currentCharacter;
            const currentGold = character.gold || 100;

            if (currentGold < cost) {
                alert('Not enough gold!');
                return;
            }

            // Apply item effects based on type
            switch (itemType) {
                case 'health_restore':
                    // Check if already at max HP
                    if (character.currentHp >= character.maxHp) {
                        alert('HP is already at maximum!');
                        return;
                    }

                    // Use healCharacter function to restore 50 HP with max HP cap
                    const actualHealing = healCharacter(character, 50);

                    // Only deduct gold if healing actually occurred
                    if (actualHealing > 0) {
                        character.gold = currentGold - cost;
                        alert(`Health restored! Healed ${actualHealing} HP.`);
                    } else {
                        alert('HP is already at maximum!');
                        return;
                    }
                    break;

                case 'strength_buff':
                    character.attackBonus = (character.attackBonus || 0) + 10;
                    character.gold = currentGold - cost;
                    alert('Strength increased! +10 Attack damage.');
                    break;

                case 'health_buff':
                    character.maxHp = character.maxHp + 20;
                    character.currentHp = character.currentHp + 20;
                    character.gold = currentGold - cost;
                    alert('Vitality increased! +20 Max HP.');
                    break;
            }

            // Update all player stats display
            updatePlayerStats(character);

            // Update global character data
            window.currentCharacter = character;
        }

        // Add event listeners to all buy buttons
        document.addEventListener('DOMContentLoaded', () => {
            const buyButtons = document.querySelectorAll('.buy-btn');

            buyButtons.forEach(button => {
                // Pressed effect
                button.addEventListener('mousedown', () => {
                    button.src = "../assets/sprites/select_button_pressed.png";
                    buttonSound.play();
                });

                // Purchase on release
                button.addEventListener('mouseup', () => {
                    button.src = "../assets/sprites/select_button.png";
                    const itemType = button.getAttribute('data-item');
                    const cost = parseInt(button.getAttribute('data-cost'));
                    buyItem(itemType, cost);
                });
            });
            // Initialize shop
            initializeShop();
        });

        function goBack() {
            if (window.currentCharacter) {
                const charData = encodeURIComponent(JSON.stringify(window.currentCharacter));
                window.location.href = `overworld.html?character=${charData}`;
            } else {
                window.location.href = 'overworld.html';
            }
        }
    </script>

    <script src="../assets/js/cursor.js"></script>
</body>

</html>