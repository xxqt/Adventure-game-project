<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Screen</title>
  <link rel="stylesheet" href="battle.css" />
  <style>
    :root{
      --scene-w: 720px;
      --scene-h: 504px;
      --side-w: 320px;
      --gap: 16px;
      --monster-scale: 7;
      --monster-nudge: 300px;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:url("../assets/overworld.png") center/cover no-repeat fixed;
      color:#e7edf5; text-align:center;
    }
    h1{ margin:12px 0; }

    #battle-layout{
      width:min(100%, calc(var(--scene-w) + var(--side-w) + var(--gap) + 24px));
      margin:0 auto 24px; padding:0 12px;
      display:grid; grid-template-columns: var(--scene-w) var(--side-w);
      gap:var(--gap); align-items:start;
    }
    @media (max-width:1100px){ #battle-layout{ grid-template-columns:1fr; } }

    .scene{
      position:relative; width:var(--scene-w); height:var(--scene-h);
      margin:8px auto 8px; overflow:hidden;
    }

    #region-bg{
      position:absolute; inset:0; z-index:1;
      background-size:cover; background-position:center; background-repeat:no-repeat;
      image-rendering:pixelated; width:100%; height:100%;
    }

    #frame{ display:none; }

    .frame-border{
      position:absolute; inset:0; z-index:2; pointer-events:none;
      border:10px solid #aeb3c3; border-radius:12px;
      box-shadow: inset 0 0 0 2px #6b7485, 0 0 0 2px rgba(0,0,0,.35);
    }

    #enemy-image{
      position:absolute; left:50%; bottom:8px;
      transform: translate(calc(-50%), var(--monster-nudge)) scale(var(--monster-scale));
      transform-origin: bottom center;
      image-rendering:pixelated; z-index:3;
      max-width:none; max-height:none;
    }

    #console{
      background:rgba(0,0,0,.35);
      padding:10px 12px; border-radius:8px; text-align:left;
      width:var(--scene-w); margin:0 auto; min-height:54px; box-sizing:border-box;
    }

    #sidebar{ display:grid; gap:var(--gap); }
    #enemy-info, #character-info{
      background:rgba(0,0,0,.75);
      padding:12px; border-radius:8px; text-align:left;
    }

    #ability-buttons{ display:grid; grid-template-columns:1fr; gap:10px; }
    .attack-btn{
      padding:10px 12px; border:2px solid #3a4a5f; background:#16212e;
      color:#e7edf5; border-radius:10px; cursor:pointer;
    }
  </style>
</head>

<body>
  <h1>Battle Screen</h1>

  <div id="battle-layout">
    <div id="left">
      <div class="scene">
        <div id="region-bg"></div>
        <img id="enemy-image" alt="Enemy" />
        <img id="frame" src="../assets/sprites/battle_background.png" alt="Frame" />
        <div class="frame-border"></div>
      </div>

      <div id="console"><p id="battleText">Ambush!</p></div>
    </div>

    <div id="sidebar">
      <div id="enemy-info">
        <h3 id="enemy-name"></h3>
        <p>HP: <span id="enemy-hp"></span></p>
      </div>
      <div id="character-info">
        <h3 id="player-name"></h3>
        <p>HP: <span id="player-hp"></span> / <span id="player-maxhp"></span></p>
        <p>Gold: <span id="player-gold"></span></p>
      </div>
      <div id="ability-buttons">
        <button class="attack-btn" onclick="playerAttack(0)">Attack 1</button>
        <button class="attack-btn" onclick="playerAttack(1)">Attack 2</button>
        <button class="attack-btn" id="run-btn" onclick="runAway()">Exit</button>
      </div>
    </div>
  </div>

  <script src="../assets/js/characters.js"></script>
  <script src="../assets/js/enemies.js"></script>
  <script src="../assets/js/regions.js"></script>

  <script>
    const qs = new URLSearchParams(location.search);

    // Load full character object if passed from shop/selector
    let player = null;
    const charData = qs.get("character");
    if(charData){
      try { player = JSON.parse(decodeURIComponent(charData)); } 
      catch(e){ console.warn("Invalid character data", e); }
    }

    // Fallbacks if no full character object
    const idx = +qs.get("character_type") || 0;
    let playerCurrentHp = player?.currentHp ?? +qs.get("currentHp") ?? 20;
    let playerMaxHp     = player?.maxHp     ?? +qs.get("maxHp") ?? 20;
    let playerGold      = player?.gold      ?? +qs.get("gold") ?? 0;
    let playerName      = player?.name      ?? (data.characters[idx]?.name || "Hero");
    let playerAbilities = player?.abilities ?? (data.characters[idx]?.abilities || [
      { name: "Strike", damage: 5, heal: 0 },
      { name: "Guard",  damage: 0, heal: 3 },
    ]);

    // Display player info
    const playerNameEl   = document.getElementById("player-name");
    const playerHpEl     = document.getElementById("player-hp");
    const playerMaxHpEl  = document.getElementById("player-maxhp");
    const playerGoldEl   = document.getElementById("player-gold");

    function updatePlayerDisplay(){
      playerNameEl.textContent  = playerName;
      playerHpEl.textContent    = playerCurrentHp;
      playerMaxHpEl.textContent = playerMaxHp;
      playerGoldEl.textContent  = playerGold;
    }

    updatePlayerDisplay();

    // Set attack buttons
    document.querySelectorAll(".attack-btn").forEach((btn,i)=>{
      if(btn.id==="run-btn") return;
      const a = playerAbilities[i];
      if(a) btn.textContent = a.name;
      else btn.style.display = "none";
    });

    // Load region and enemy
    const regionKey = (qs.get("region_type") || "forest").toLowerCase();
    const regionCfg = (typeof regions !== "undefined" && regions[regionKey]) ? regions[regionKey] : null;
    const regionBg  = (regionCfg?.battleBg) ? regionCfg.battleBg : "../assets/sprites/game_background.png";
    document.getElementById("region-bg").style.backgroundImage = `url("${regionBg}")`;

    const catalog = (typeof enemies !== "undefined" && enemies.enemies) ? enemies.enemies : [];
    let pool = [];
    if(regionCfg && Array.isArray(regionCfg.monstersByName)){
      pool = regionCfg.monstersByName.length ? catalog.filter(e=>regionCfg.monstersByName.includes(e.name)) : [];
    } else pool = catalog.slice();

    if(!pool.length){
      document.getElementById("enemy-name").textContent = "No enemies here";
      document.getElementById("enemy-hp").textContent   = "";
      document.getElementById("enemy-image").style.display = "none";
      document.getElementById("battleText").textContent = "This area is safe.";
      document.querySelectorAll(".attack-btn").forEach(b=>{ if(b.id!=="run-btn") b.disabled=true; });
      window.playerAttack = ()=>{};
    } else {
      const randomEnemy   = pool[Math.floor(Math.random()*pool.length)];
      let enemyName       = randomEnemy.name;
      let enemyHP         = randomEnemy.hp;
      const enemyAbilities= randomEnemy.abilities || [];
      let enemyImage      = randomEnemy.animations.idle;
      const enemyDiff     = Number(randomEnemy.difficulty || 1);

      document.getElementById("enemy-name").textContent = enemyName;
      document.getElementById("enemy-hp").textContent   = enemyHP;
      document.getElementById("enemy-image").src        = enemyImage;
      document.getElementById("battleText").textContent = `A wild ${enemyName} appears!`;

      function updateEnemyDisplay(){
        document.getElementById("enemy-hp").textContent = enemyHP;
        document.getElementById("enemy-image").src = enemyImage;
      }

      function move(name, damage, heal){
        playerCurrentHp = Math.min(playerCurrentHp + (heal||0), playerMaxHp);
        enemyHP -= (damage||0);
        if(playerCurrentHp<0) playerCurrentHp=0;
        if(enemyHP<0) enemyHP=0;
        document.getElementById("battleText").innerText = `Player used ${name}!`;
        updateEnemyDisplay();
        updatePlayerDisplay();
      }

      function enemyMove(name, damage, heal){
        enemyHP += (heal||0);
        playerCurrentHp -= (damage||0);
        if(playerCurrentHp<0) playerCurrentHp=0;
        if(enemyHP<0) enemyHP=0;
        document.getElementById("battleText").innerText = `Enemy used ${name}!`;
        updateEnemyDisplay();
        updatePlayerDisplay();
      }

      function checkBattleOutcome(){
        if(playerCurrentHp<=0){
          document.getElementById("battleText").innerText="You were defeated!";
          disableAttacks();
        } else if(enemyHP<=0){
          enemyImage = randomEnemy.animations.death; updateEnemyDisplay();
          const goldReward = 10*enemyDiff;
          playerGold += goldReward;
          updatePlayerDisplay();
          document.getElementById("battleText").innerText = `You defeated the ${enemyName}! +${goldReward} gold`;
          disableAttacks();
        }
      }

      function disableAttacks(){
        document.querySelectorAll(".attack-btn").forEach(b=>{ if(b.id!=="run-btn") b.disabled=true; });
      }

      window.playerAttack = function(index){
        const a = playerAbilities[index]; if(!a) return;
        move(a.name, a.damage, a.heal);
        if(enemyHP<=0){ checkBattleOutcome(); return; }

        setTimeout(()=>{
          enemyImage = randomEnemy.animations.attack; updateEnemyDisplay();
          setTimeout(()=>{
            const e = enemyAbilities[Math.floor(Math.random()*enemyAbilities.length)] || {name:"Swipe", damage:5, heal:0};
            enemyMove(e.name, e.damage, e.heal);
            setTimeout(()=>{ enemyImage=randomEnemy.animations.idle; updateEnemyDisplay(); checkBattleOutcome(); },400);
          },700);
        },400);
      };
    }

    window.runAway = function(){
      // Save current player state in query string
      const charCopy = {
        name: playerName,
        abilities: playerAbilities,
        currentHp: playerCurrentHp,
        maxHp: playerMaxHp,
        gold: playerGold
      };
      qs.set("character", encodeURIComponent(JSON.stringify(charCopy)));
      location.href = `overworld.html?${qs.toString()}`;
    };

    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") runAway(); });

  </script>
</body>
</html>
